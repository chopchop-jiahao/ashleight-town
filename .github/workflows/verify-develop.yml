name: Verify Develop

on:
  pull_request:
    branches: ['develop']

env:
  GODOT_VERSION: 4.5.1

jobs:
  setup:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Godot (macOS)
        run: |
          wget https://github.com/godotengine/godot-builds/releases/download/${GODOT_VERSION}-stable/Godot_v${GODOT_VERSION}-stable_macos.universal.zip -O godot-mac.zip
          unzip godot-mac.zip -d godot
          chmod +x godot/Godot.app/Contents/MacOS/Godot
        shell: bash

      - name: Download and install Godot export templates
        run: |
          wget https://github.com/godotengine/godot-builds/releases/download/${GODOT_VERSION}-stable/Godot_v${GODOT_VERSION}-stable_export_templates.tpz -O export_templates.tpz
          mkdir -p "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable"
          unzip export_templates.tpz -d "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable"
          
          # 搬檔案到 Godot 預期的路徑
          mv "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable/templates/macos.zip" \
             "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable/macos.zip"
          mv "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable/templates/windows_release_x86_64.exe" \
             "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable/windows_release_x86_64.exe"
          mv "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable/templates/windows_debug_x86_64.exe" \
             "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable/windows_debug_x86_64.exe"

          echo "Listing all installed templates:"
          ls -l "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable"
        shell: bash

      - name: Set Godot executable
        run: echo "GODOT_EXE=$(pwd)/godot/Godot.app/Contents/MacOS/Godot" >> $GITHUB_ENV

      - name: Build Mac executable
        run: |
          mkdir -p build/mac
          ${{ env.GODOT_EXE }} --no-window \
            --export-release "ashleigh-town-macOS" \
            build/mac/Ashleigh-Town.app \
            --templates-path "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable"

      - name: Build Windows executable
        run: |
          mkdir -p build/windows
          ${{ env.GODOT_EXE }} --no-window \
            --export-release "ashleigh-town-windows" \
            build/windows/Ashleigh-Town.exe \
            --templates-path "$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.stable"
